name: PR Labeler

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const title = pr.title;
            const body = pr.body || '';
            const labels = [];
            
            // PR„ÅÆÁ®ÆÈ°û„ÇíÂà§ÂÆö
            if (body.includes('- [x] üêõ „Éê„Ç∞‰øÆÊ≠£') || title.includes('fix')) {
              labels.push('bug', 'fix');
            }
            if (body.includes('- [x] ‚ú® Êñ∞Ê©üËÉΩ') || title.includes('feat')) {
              labels.push('enhancement', 'feature');
            }
            if (body.includes('- [x] üí• Breaking Change')) {
              labels.push('breaking-change');
            }
            if (body.includes('- [x] üìö „Éâ„Ç≠„É•„É°„É≥„Éà') || title.includes('docs')) {
              labels.push('documentation');
            }
            if (body.includes('- [x] üé® „Çπ„Çø„Ç§„É´')) {
              labels.push('style');
            }
            if (body.includes('- [x] ‚ôªÔ∏è „É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞') || title.includes('refactor')) {
              labels.push('refactor');
            }
            if (body.includes('- [x] ‚ö° „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ') || title.includes('perf')) {
              labels.push('performance');
            }
            if (body.includes('- [x] ‚úÖ „ÉÜ„Çπ„Éà') || title.includes('test')) {
              labels.push('test');
            }
            if (body.includes('- [x] üîß „Åù„ÅÆ‰ªñ')) {
              labels.push('chore');
            }
            
            // Â§âÊõ¥„Åó„Åü„Éï„Ç°„Ç§„É´„Å´Âü∫„Å•„Åè„É©„Éô„É´‰ªò„Åë
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const changedFiles = files.map(file => file.filename);
            
            // „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('src/components/') || 
              file.includes('src/pages/') || 
              file.includes('.tsx') || 
              file.includes('.jsx') ||
              file.includes('.css') ||
              file.includes('.scss')
            )) {
              labels.push('frontend');
            }
            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('src/api/') || 
              file.includes('src/services/') || 
              file.includes('src/models/') ||
              file.includes('server/') ||
              file.includes('.py') ||
              file.includes('.java') ||
              file.includes('.go')
            )) {
              labels.push('backend');
            }
            
            // „Éá„Éº„Çø„Éô„Éº„ÇπÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('migrations/') || 
              file.includes('schema.') || 
              file.includes('.sql')
            )) {
              labels.push('database');
            }
            
            // CI/CDÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('.github/workflows/') || 
              file.includes('Dockerfile') || 
              file.includes('docker-compose') ||
              file.includes('.yml') ||
              file.includes('.yaml')
            )) {
              labels.push('ci-cd');
            }
            
            // „ÉÜ„Çπ„ÉàÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('test/') || 
              file.includes('tests/') || 
              file.includes('__tests__/') ||
              file.includes('.test.') ||
              file.includes('.spec.')
            )) {
              labels.push('test');
            }
            
            // „Éâ„Ç≠„É•„É°„É≥„ÉàÈñ¢ÈÄ£
            if (changedFiles.some(file => 
              file.includes('README') || 
              file.includes('.md') || 
              file.includes('docs/')
            )) {
              labels.push('documentation');
            }
            
            // PR„ÅÆ„Çµ„Ç§„Ç∫„Å´Âü∫„Å•„Åè„É©„Éô„É´
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;
            
            if (totalChanges < 50) {
              labels.push('size/small');
            } else if (totalChanges < 200) {
              labels.push('size/medium');
            } else if (totalChanges < 500) {
              labels.push('size/large');
            } else {
              labels.push('size/extra-large');
            }
            
            // „Éâ„É©„Éï„ÉàPR„ÅÆÂ†¥Âêà
            if (pr.draft) {
              labels.push('work-in-progress');
            }
            
            // „É©„Éô„É´„ÇíËøΩÂä†
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

      - name: Request reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // „Éâ„É©„Éï„ÉàPR„ÅÆÂ†¥Âêà„ÅØ„É¨„Éì„É•„Éº„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Å™„ÅÑ
            if (pr.draft) return;
            
            const body = pr.body || '';
            const reviewers = [];
            
            // ÁâπÂÆö„ÅÆÂ§âÊõ¥„Å´ÂØæ„Åô„ÇãËá™Âãï„É¨„Éì„É•„Éº„Ç¢„Çµ„Ç§„É≥
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const changedFiles = files.map(file => file.filename);
            
            // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Èñ¢ÈÄ£„ÅÆÂ§âÊõ¥
            if (changedFiles.some(file => 
              file.includes('auth') || 
              file.includes('security') || 
              file.includes('permission')
            )) {
              reviewers.push('security-team');
            }
            
            // „Ç§„É≥„Éï„É©Èñ¢ÈÄ£„ÅÆÂ§âÊõ¥
            if (changedFiles.some(file => 
              file.includes('Dockerfile') || 
              file.includes('docker-compose') || 
              file.includes('.github/workflows/')
            )) {
              reviewers.push('devops-team');
            }
            
            // PR„Å´„É¨„Éì„É•„Éº„Ç¢„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            const ccMatch = body.match(/\/cc @(\w+)/g);
            if (ccMatch) {
              ccMatch.forEach(match => {
                const username = match.replace('/cc @', '');
                if (!reviewers.includes(username)) {
                  reviewers.push(username);
                }
              });
            }
            
            // „É¨„Éì„É•„Éº„Ç¢„Çí„É™„ÇØ„Ç®„Çπ„Éà
            if (reviewers.length > 0) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers: reviewers
                });
              } catch (error) {
                console.log('Error requesting reviewers:', error.message);
              }
            }
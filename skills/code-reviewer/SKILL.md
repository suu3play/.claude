---
name: code-reviewer
description: コード変更を自動レビューし、品質・セキュリティ・パフォーマンスの問題を検出するスキル。「コードレビュー」「変更をレビュー」「レビューして」と依頼された時に使用
---

# Code Reviewer - コード自動レビュースキル

このスキルは、コード変更を分析し、品質・セキュリティ・パフォーマンスの観点から自動的にレビューを実施します。

## 使用タイミング

以下のいずれかの表現でレビュー依頼された時に自動的に起動します：

- 「コードレビュー」「コードレビューして」
- 「変更をレビュー」「レビューして」
- 「品質チェック」「コード確認」

## 実行フロー

### ステップ1: 変更内容の確認

1. **Git差分の取得**
   ```bash
   git status --short
   git diff --stat
   git diff
   ```

2. **変更ファイルの分析**
   - 変更されたファイル一覧
   - 追加・削除・変更行数
   - 影響範囲の推定

### ステップ2: コード品質チェック

`.claude/rules/testing-requirements.md`に従って以下を実行：

1. **型チェック**（TypeScript/Python）
   ```bash
   # TypeScript
   npm run type-check

   # Python
   mypy .
   ```

2. **リント実行**
   ```bash
   # TypeScript/JavaScript
   npm run lint

   # Python
   pylint src/
   flake8 src/
   ```

3. **ビルドチェック**
   ```bash
   npm run build
   ```

4. **テスト実行**
   ```bash
   npm test
   ```

### ステップ3: セキュリティチェック

1. **依存関係の脆弱性チェック**
   ```bash
   npm audit
   ```

2. **コード内のセキュリティ問題検出**
   - SQL Injection の可能性
   - XSS の可能性
   - ハードコードされた機密情報
   - 安全でない関数の使用

### ステップ4: コードレビュー実施

`.claude/templates/code-review-checklist-template.md`のチェックリストに従ってレビュー：

#### 機能性
- 要件を満たしているか
- エッジケースを考慮しているか
- エラーハンドリングが適切か

#### コード品質
- 命名が適切か
- 関数が単一責任を守っているか
- 重複コードがないか
- マジックナンバーを避けているか

#### TypeScript/型安全性
- any の使用がないか
- 型定義が適切か
- null 安全性が確保されているか

#### パフォーマンス
- 不要な再レンダリングがないか
- N+1問題がないか
- 非同期処理が最適化されているか

#### セキュリティ
- 入力検証が適切か
- XSS対策があるか
- 機密情報の取り扱いが安全か

### ステップ5: レビュー結果の生成

1. **結果ファイルの作成**
   - 出力先: `./code_check/code_review_yyyyMMddHHmm.md`
   - 形式: `.claude/templates/code-review-checklist-template.md`

2. **レビュー結果の内容**
   ```markdown
   # コードレビュー結果

   レビュー日: YYYY-MM-DD HH:MM
   対象ブランチ: [ブランチ名]

   ## 変更サマリー
   - 変更ファイル数: X件
   - 追加行数: +XXX
   - 削除行数: -XXX

   ## コード品質チェック結果
   - ✅ 型チェック: 成功
   - ✅ リント: 成功
   - ✅ ビルド: 成功
   - ✅ テスト: 成功（XX/XX passed）

   ## セキュリティチェック結果
   - ✅ 依存関係: 脆弱性なし
   - ⚠️ コード: 1件の警告

   ## レビューコメント

   ### 良かった点
   - [具体的な良い点]

   ### 改善が必要な点
   - [ファイル名:行番号] [問題の説明]

   ### 推奨事項
   - [改善提案]

   ## 総合評価
   レビュー結果: [承認/修正依頼/コメント]
   ```

### ステップ6: ユーザーへの報告

1. **結果サマリーの表示**
   - コード品質チェック結果
   - セキュリティチェック結果
   - 主要な改善点

2. **詳細レビューファイルの場所を通知**
   - `./code_check/code_review_yyyyMMddHHmm.md` を参照するよう案内

## 使用例

### 例1: 基本的なレビュー

**ユーザー**: コードレビューして

**スキルの動作**:
1. Git差分を確認
2. 変更されたファイル: 3件（追加50行、削除10行）
3. コード品質チェック実行
   - 型チェック: ✅ 成功
   - リント: ❌ 2件のエラー
   - ビルド: ✅ 成功
   - テスト: ✅ 成功
4. セキュリティチェック実行
   - 依存関係: ✅ 問題なし
   - コード: ⚠️ 1件の警告（security/detect-object-injection）
5. コードレビュー実施
   - 命名: 良好
   - 重複コード: なし
   - エラーハンドリング: ⚠️ 改善の余地あり
6. レビュー結果を生成して報告

**レビュー結果**:
```
❌ リントエラーがあります（2件）
⚠️ セキュリティ警告があります（1件）
⚠️ エラーハンドリングの改善を推奨

詳細は ./code_check/code_review_202501281545.md を確認してください
```

### 例2: プルリクエスト前のレビュー

**ユーザー**: PR作成前にレビューして

**スキルの動作**:
1. すべてのチェックを実施
2. コード品質チェック: すべて成功
3. セキュリティチェック: 問題なし
4. コードレビュー: 良好
5. PRテンプレートに記載する内容を提案

**レビュー結果**:
```
✅ すべてのチェックが成功しました

PR作成の準備が整っています。
以下の内容でPRを作成することを推奨します：

【変更内容】
- ユーザープロフィール編集機能を追加
- バリデーション機能を実装
- テストケースを追加（カバレッジ: 95%）

【テスト結果】
- 型チェック: ✅
- リント: ✅
- ビルド: ✅
- テスト: ✅ (48/48 passed)
```

## レビュー観点の詳細

### 1. 機能性レビュー

- **要件充足**: Issue/タスクの要件をすべて満たしているか
- **エッジケース**: null/undefined/空配列/境界値を考慮しているか
- **エラーハンドリング**: 適切なtry-catch、エラーメッセージ

### 2. コード品質レビュー

- **命名規則**: 変数・関数・クラス名が明確か
- **単一責任**: 1つの関数が1つのことのみを行うか
- **重複排除**: DRY原則に従っているか
- **可読性**: コメントが適切、ネストが深すぎないか

### 3. TypeScript型安全性レビュー

- **any禁止**: any の使用を避けているか
- **型推論活用**: 不要な型定義を避けているか
- **null安全**: Optional Chaining、Nullish Coalescing の使用

### 4. パフォーマンスレビュー

- **React最適化**: React.memo、useMemo、useCallback の適切な使用
- **N+1問題**: ループ内でのAPI呼び出しがないか
- **非同期最適化**: Promise.all の活用、不要な await の削減

### 5. セキュリティレビュー

- **入力検証**: ユーザー入力のバリデーション・サニタイゼーション
- **XSS対策**: dangerouslySetInnerHTML の使用制限
- **認証・認可**: トークンの取り扱い、権限チェック
- **機密情報**: パスワード等のハードコード禁止

### 6. アクセシビリティレビュー

- **セマンティックHTML**: 適切なHTML要素の使用
- **キーボード操作**: すべての機能がキーボードで操作可能
- **ARIA属性**: 必要な箇所に適切なARIA属性

## 重要な注意事項

1. **自動チェックツールの活用**
   - ESLint、TypeScript、テストを必ず実行
   - 自動で検出できる問題は手動レビュー前に修正

2. **レビュー結果の記録**
   - 必ず `./code_check/` にレビュー結果を保存
   - 履歴として保持し、品質改善の追跡に活用

3. **建設的なフィードバック**
   - 問題点だけでなく、良い点も指摘
   - 改善案を具体的に提示
   - 優先度を明確に（致命的/重要/推奨）

4. **false positive への対応**
   - ESLint警告が正当な理由で無視される場合は確認
   - eslint-disable コメントには理由を記載

5. **プロジェクト固有ルールの尊重**
   - 既存のコーディング規約に従う
   - プロジェクトの設計パターンを尊重

## 関連ファイル

- `.claude/rules/testing-requirements.md` - テスト要件
- `.claude/rules/code-quality-standards.md` - コード品質基準
- `.claude/templates/code-review-checklist-template.md` - レビューチェックリスト
- `.claude/templates/code-quality-check-template.md` - 品質チェックテンプレート

## 拡張可能性

このスキルは以下の機能拡張が可能です：

1. **自動修正提案**: Lintエラーの自動修正案
2. **複雑度分析**: Cyclomatic Complexity の計算
3. **カバレッジ分析**: テストカバレッジの詳細分析
4. **パフォーマンスプロファイル**: ボトルネック検出
5. **AIレビュー**: コードの意図理解とロジック検証

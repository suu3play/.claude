---
name: analysis-issue-creator
description: コード分析結果を基にユーザーと対話しながら適切なGitHub Issueを作成するスキル。「分析結果からissueを作成して」「この問題をissue化して」「バグレポートをGitHubに登録して」と依頼された時に使用。優先度やカテゴリをユーザーと確認しながら、適切な粒度でIssueを作成する
---

# Analysis Issue Creator - 分析結果Issue作成スキル

このスキルは、コード分析結果をユーザーと対話しながら整理し、適切な粒度と優先度でGitHub Issueを作成します。

## 使用タイミング

- 「分析結果からissueを作成して」と依頼された時
- 「この問題をissue化して」と依頼された時
- 「バグレポートをGitHubに登録して」と依頼された時
- 「エラーをissueにまとめて」と依頼された時
- コード分析後にIssue作成が必要な時

## 実行フロー

### ステップ1: 分析結果の整理

1. **分析結果の要約を作成**
   - エラー/警告の総数を集計
   - カテゴリ別（バグ、リファクタリング、ドキュメント等）に分類
   - 優先度別（Critical, High, Medium, Low）に整理

2. **サマリーをユーザーに提示**
   ```
   📊 コード分析結果サマリー

   総問題数: 362件
   - 🔴 Critical: 31件（ビルドエラー、欠落ファイル）
   - 🟠 High: 148件（型エラー、未定義メソッド）
   - 🟡 Medium: 150件（Null安全性、リファクタリング）
   - ⚪ Low: 33件（デバッグコード、TODOコメント）

   カテゴリ別:
   - 🐛 バグ: 180件
   - 🔧 リファクタリング: 120件
   - 📝 ドキュメント: 36件
   - ⚡ パフォーマンス: 15件
   - 🧪 テスト: 11件
   ```

### ステップ2: Issue作成方針の確認

ユーザーに以下を確認:

1. **作成範囲の確認**
   ```
   どの範囲でIssueを作成しますか？

   1. すべて作成（362件）※推奨しません
   2. Critical + Highのみ（179件）
   3. Criticalのみ（31件）
   4. カテゴリを指定（例: バグのみ）
   5. 優先度と範囲を指定（例: Critical+High かつ バグのみ）
   6. カスタム（詳細に指定）
   ```

2. **Issue粒度の確認**
   ```
   Issue作成の粒度はどうしますか？

   1. 詳細（1問題 = 1Issue）- 多数のIssueが作成されます
   2. 中粒度（関連する問題をグループ化）- 推奨
   3. 粗粒度（カテゴリごとに1Issue）- 管理しやすいが詳細度が低い
   ```

3. **グループ化基準の確認**（中粒度の場合）
   ```
   問題のグループ化基準:

   1. ファイル単位（同じファイルの問題をまとめる）
   2. 機能単位（同じ機能の問題をまとめる）
   3. エラー種類単位（同じエラータイプをまとめる）
   4. 自動判定（関連性の高い問題を自動グループ化）
   ```

### ステップ3: Issue内容の生成

各Issueについて以下の構成で内容を生成:

#### タイトル形式

```
[カテゴリ] 簡潔な説明 (影響範囲)
```

例:
- `[Bug] 欠落モデルファイルの作成 (Badge, Goal関連)`
- `[Refactoring] 未定義メソッドの実装 (AnswerRepository)`
- `[Bug] パス記述エラーの修正 (goal_management_usecase.dart)`

#### Issue本文テンプレート

```markdown
## 問題の概要
[問題の簡潔な説明]

## 影響範囲
- 影響を受けるファイル一覧
- 影響を受ける機能

## 詳細
### 発生している問題
[具体的なエラー内容や問題の詳細]

### 原因
[問題の原因分析]

## 修正方法
### 推奨アプローチ
[推奨される修正方法]

### 実装手順
1. [手順1]
2. [手順2]
3. [手順3]

### コード例（該当する場合）
```dart
// 修正前
[問題のあるコード]

// 修正後
[修正後のコード]
```

## チェックリスト
- [ ] コード修正
- [ ] テスト追加/修正
- [ ] ドキュメント更新
- [ ] flutter analyze でエラーがないことを確認

## 優先度
[Critical/High/Medium/Low] - [理由]

## 見積もり
[作業時間の目安]

## 関連Issue
[関連するIssue番号があれば記載]
```

### ステップ4: Issue作成計画の提示

生成したIssue内容をユーザーに提示:

```
作成予定のIssue一覧（10件）:

1. [Bug] 欠落モデルファイルの作成
   - 優先度: Critical
   - 影響: badge.dart, goal.dart, goal_milestone.dart
   - 見積: 4-6時間

2. [Bug] 欠落リポジトリインターフェースの作成
   - 優先度: Critical
   - 影響: BadgeRepository, GoalRepository, UserRepository
   - 見積: 3-4時間

3. [Bug] パス記述エラーの修正
   - 優先度: High
   - 影響: goal_management_usecase.dart (Unicodeエスケープ)
   - 見積: 30分

[...]

このままIssueを作成しますか？
- はい（すべて作成）
- 一部のみ作成（番号を指定）
- 内容を修正
- キャンセル
```

### ステップ5: GitHub Issue作成

#### 5-1: 標準ラベルの読み込み

Issue作成前に`.claude/labels.md`から標準ラベル定義を読み込む:

```bash
# labels.mdの存在確認と読み込み
cat .claude/labels.md
```

ラベルマッピング:
- **Type系ラベル**（必須）
  - バグ → `Type：バグ`
  - リファクタリング → `Type：リファクタリング`
  - ドキュメント → `Type：ドキュメント更新`
  - 新機能 → `Type：新機能・既存改修`
  - 作業 → `Type：作業`

- **Priority系ラベル**（必須）
  - Critical → `Priority：最優先`
  - High → `Priority：中`
  - Medium → `Priority：中`
  - Low → `Priority：低`

#### 5-2: Issue作成実行

承認後、順次Issueを作成:

```bash
# 標準ラベルを使用したIssue作成
gh issue create \
  --title "[Bug] 欠落モデルファイルの作成 (Badge, Goal関連)" \
  --body-file issue_content_1.md \
  --label "Type：バグ" \
  --label "Priority：最優先"
```

**作成時の注意点**:

1. **レート制限への配慮**
   - 大量Issue作成時は5件ごとに1秒待機
   - エラー発生時は自動リトライ（最大3回）

2. **標準ラベルの適用**
   - `.claude/labels.md`から読み取った標準ラベルを使用
   - プロジェクトに標準ラベルが未設定の場合は警告を表示
   - Type系ラベルとPriority系ラベルを必ず付与

3. **ラベルが存在しない場合の対応**
   - 標準ラベルがプロジェクトに未設定の場合、`/copy-labels`実行を提案
   - ラベルなしでIssueを作成するか確認

3. **マイルストーンの設定**
   - ユーザーに確認してマイルストーンを設定
   - デフォルトは設定なし

4. **アサイン設定**
   - ユーザーに確認して自動アサインするか決定
   - デフォルトは未アサイン

### ステップ6: 作成結果の報告

1. **作成完了サマリー**
   ```
   ✅ Issue作成完了

   作成したIssue: 10件

   Critical:
   - #45: [Bug] 欠落モデルファイルの作成
   - #46: [Bug] 欠落リポジトリインターフェースの作成

   High:
   - #47: [Bug] パス記述エラーの修正
   - #48: [Refactoring] 未定義メソッドの実装
   - #49: [Bug] Null安全性の改善
   [...]

   次のステップ:
   1. Critical Issueから優先的に対応
   2. 各Issueにブランチを作成して修正
   3. PRを作成してレビュー
   ```

2. **レポートファイルの生成（オプション）**

   `./reports/issues_created_yyyyMMddHHmm.md`に保存:

   ```markdown
   # GitHub Issue作成レポート

   作成日時: 2025-01-26 14:30
   プロジェクト: growth-diary

   ## 作成サマリー
   - 総作成数: 10件
   - Critical: 2件
   - High: 5件
   - Medium: 3件

   ## 作成したIssue一覧

   ### Critical
   - #45: [Bug] 欠落モデルファイルの作成
     - URL: https://github.com/user/repo/issues/45
     - 見積: 4-6時間

   [...]
   ```

## グループ化ロジック（中粒度の場合）

### ファイル単位グループ化

同じファイルで発生している問題をまとめる:

```
例: badge_management_usecase.dart
- 84件の型定義エラー
- 53件の未定義識別子
- 20件のNull安全性問題
→ 1つのIssueにまとめる
```

### 機能単位グループ化

関連する機能の問題をまとめる:

```
例: Badge機能
- badge_management_usecase.dart の問題
- badge_repository.dart の問題
- badge.dart モデルの欠落
→ 1つのIssueにまとめる
```

### エラー種類単位グループ化

同じエラータイプをまとめる:

```
例: 欠落ファイル参照（uri_does_not_exist）
- badge.dart が存在しない
- goal.dart が存在しない
- goal_milestone.dart が存在しない
→ 1つのIssueにまとめる
```

### 自動グループ化

以下の条件で自動判定:

1. **同一ファイル内** かつ **同一エラータイプ** → 1Issue
2. **同一機能** かつ **関連性あり** → 1Issue
3. **Critical** かつ **即座対応必要** → 個別Issue
4. それ以外 → エラータイプでグループ化

## 使用例

### 例1: Criticalのみ作成

**ユーザー**: growth-diaryの分析結果から、Criticalのissueだけ作成して

**スキルの動作**:
1. 分析結果を整理（362件 → Critical 31件に絞り込み）
2. サマリーを表示
3. 「Criticalのみ」を確認
4. Issue粒度を確認（中粒度を推奨）
5. グループ化基準を確認（自動判定を推奨）
6. 5件のIssueを生成（グループ化後）
7. 内容を提示して承認待ち
8. 承認後、GitHub Issueを作成
9. 結果レポート表示

### 例2: バグのみ、詳細粒度で作成

**ユーザー**: バグだけをissue化して。1つずつ詳細に

**スキルの動作**:
1. 分析結果からバグのみ抽出（180件）
2. サマリー表示
3. 「詳細粒度」を確認
4. 180件のIssueを生成
5. 「多数のIssueが作成されます」と警告
6. ユーザーに再確認
7. 承認後、順次作成（レート制限に配慮）
8. 結果レポート表示

### 例3: カスタム指定

**ユーザー**: HighとCriticalのバグとリファクタリングだけ、ファイル単位でまとめて

**スキルの動作**:
1. 条件でフィルタ（High+Critical、Bug+Refactoring → 約120件）
2. サマリー表示
3. ファイル単位でグループ化
4. 約15件のIssueを生成
5. 内容を提示
6. 承認後作成
7. 結果レポート

## エラーハンドリング

### GitHub認証エラー

```
エラー: GitHub認証が必要です。
以下のコマンドで認証してください:
  gh auth login
```

### Issue作成失敗

```
エラー: Issue #X の作成に失敗しました
原因: API rate limit exceeded
対処: 1時間後に再実行するか、--retry オプションで自動リトライ
```

### レート制限

```
警告: GitHubのレート制限に達しました
作成済み: 50件 / 予定: 100件
残り50件は1時間後に自動再開しますか？
```

### ラベルが存在しない

```
警告: ラベル 'priority: critical' が存在しません
作成しますか？ (y/n)
```

## 設定オプション

環境変数でカスタマイズ可能:

```bash
# デフォルトの粒度（fine/medium/coarse）
export ISSUE_DEFAULT_GRANULARITY=medium

# デフォルトの優先度フィルター
export ISSUE_DEFAULT_PRIORITY=critical,high

# 自動アサイン
export ISSUE_AUTO_ASSIGN=true

# マイルストーン
export ISSUE_DEFAULT_MILESTONE=v1.0

# レポート出力先
export ISSUE_REPORT_DIR=./reports

# レート制限の待機時間（秒）
export ISSUE_RATE_LIMIT_WAIT=1
```

## 注意事項

1. **大量Issue作成の警告**
   - 20件以上作成する場合は必ず警告を表示
   - ユーザーに粒度の見直しを提案

2. **既存Issue重複チェック**
   - タイトルの類似度をチェック
   - 70%以上類似している場合は警告

3. **プライベートリポジトリ権限**
   - Issue作成権限を事前確認
   - 権限不足の場合はエラー表示

4. **Issue番号の記録**
   - 作成したIssue番号を記録
   - 関連Issueのリンク作成に活用

5. **ユーザー対話の重要性**
   - 自動判断せず、必ずユーザーに確認
   - 特に粒度とフィルター条件は重要

## 関連スキル

- `code-analyzer` - コード分析実行スキル（前工程）
- `issue-fixer` - Issue対応スキル（後工程）
- `pr-creator` - PR作成スキル（後工程）

## 拡張機能案

1. **AI要約**: 長いエラーメッセージを自動要約
2. **優先度自動判定**: 過去データから優先度を学習
3. **Issue間の依存関係**: 自動で関連Issueをリンク
4. **テンプレートカスタマイズ**: プロジェクトごとのテンプレート対応
5. **Slack/Discord通知**: Issue作成時に通知

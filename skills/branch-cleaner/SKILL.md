---
name: branch-cleaner
description: ローカルブランチの状況を確認し、コミット済み・mainに反映済みの変更はブランチを自動削除してmainブランチを最新に更新するスキル。「ブランチを整理して」「ブランチクリーンアップ」「不要なブランチを削除」と依頼された時に使用。単一プロジェクトまたは全プロジェクト一括処理が可能
---

# Branch Cleaner - ブランチ自動整理スキル

このスキルは、ローカルブランチの状況を確認し、安全にマージ済みブランチを削除してmainブランチを最新に更新します。

## 使用タイミング

- 「ブランチを整理して」と依頼された時
- 「ブランチクリーンアップして」と依頼された時
- 「不要なブランチを削除して」と依頼された時
- 「mainブランチを最新にして」と依頼された時
- 「全プロジェクトのブランチを整理して」と依頼された時

## 動作モード

### 1. 単一プロジェクトモード

指定されたプロジェクトのみを処理

**発動キーワード**:
- 「[プロジェクト名]のブランチを整理して」
- 「growth-diaryのブランチクリーンアップして」

### 2. 全プロジェクトモード

`[プロジェクトルート]`配下の全プロジェクトを一括処理

**発動キーワード**:
- 「全プロジェクトのブランチを整理して」
- 「すべてのプロジェクトをクリーンアップして」
- 「allでブランチ整理して」

## 実行フロー

### ステップ1: プロジェクト情報の取得

#### 単一プロジェクトモード

1. **プロジェクト名の特定**
   - ユーザーの指示から抽出
   - 指定がない場合はカレントディレクトリから判定

2. **プロジェクトディレクトリへ移動**
   ```bash
   cd "[プロジェクトルート]/[プロジェクト名]"
   ```

3. **Gitリポジトリ確認**
   ```bash
   git rev-parse --git-dir
   ```

#### 全プロジェクトモード

1. **プロジェクト一覧取得**
   ```bash
   # [プロジェクトルート]配下の全サブディレクトリを検索
   find "[プロジェクトルート]" -maxdepth 1 -type d
   ```

2. **.gitディレクトリ存在確認**
   - `.git`が存在するディレクトリのみを対象
   - 非Gitディレクトリはスキップ

3. **処理対象リストの作成**
   ```
   対象プロジェクト:
   1. growth-diary
   2. portfolio
   3. source-flow
   4. hobby-weather
   ...
   合計: 8プロジェクト
   ```

### ステップ2: ブランチ状態の確認

各プロジェクトで以下を確認:

1. **ワーキングツリーの状態**
   ```bash
   git status
   ```

   確認項目:
   - 未コミットの変更
   - 未追跡のファイル
   - ステージされた変更

2. **ローカルブランチ一覧**
   ```bash
   git branch -v
   ```

   取得情報:
   - ブランチ名
   - 最新コミットハッシュ
   - リモート追跡状況

3. **未プッシュコミットの確認**
   ```bash
   git log --branches --not --remotes --oneline
   ```

   確認:
   - リモートにプッシュされていないコミット
   - ローカルのみに存在する変更

4. **現在のブランチ**
   ```bash
   git branch --show-current
   ```

### ステップ3: 安全性チェック

以下の条件をすべて満たす場合のみ次のステップへ:

#### ✅ 安全な状態

```
✅ ワーキングツリー: クリーン
✅ 未コミット変更: なし
✅ 未プッシュコミット: なし
```

#### ⚠️ 安全でない状態（スキップ）

**未コミット変更がある場合**:
```
⚠️ スキップ: growth-diary

理由: 未コミットの変更があります

変更されたファイル:
  M  src/components/UserProfile.tsx
  ?? src/components/NewComponent.tsx

対処方法:
  git add .
  git commit -m "変更をコミット"
```

**未プッシュコミットがある場合**:
```
⚠️ スキップ: portfolio

理由: プッシュされていないコミットがあります

未プッシュコミット (2件):
  abc1234 feat: 新機能追加
  def5678 fix: バグ修正

対処方法:
  git push origin [ブランチ名]
```

### ステップ4: 削除対象ブランチの特定

1. **mainブランチ以外を抽出**
   ```bash
   git branch | grep -v "main"
   ```

2. **各ブランチのマージ状況確認**
   ```bash
   # マージ済みブランチ
   git branch --merged main

   # 未マージブランチ
   git branch --no-merged main
   ```

3. **削除対象リストの作成**
   ```
   削除対象ブランチ (growth-diary):
   - feature/issue-1  (マージ済み)
   - feature/issue-2  (マージ済み)
   - fix/typo         (マージ済み)

   保護されるブランチ:
   - feature/wip      (未マージ)
   ```

### ステップ5: ユーザー確認

削除実行前にユーザーに確認:

#### 単一プロジェクトモード

```
📋 growth-diary のブランチクリーンアップ

削除対象ブランチ (3件):
- feature/issue-1
- feature/issue-2
- fix/typo

これらのブランチを削除してよろしいですか？
[Y/n]:
```

#### 全プロジェクトモード

```
📋 全プロジェクトのブランチクリーンアップ

対象プロジェクト数: 8
削除予定ブランチ数: 27

プロジェクト別内訳:
- growth-diary: 3ブランチ
- portfolio: 5ブランチ
- source-flow: 4ブランチ
- hobby-weather: 2ブランチ
...

すべてのプロジェクトでブランチクリーンアップを実行しますか？
[Y/n]:
```

ユーザーが「No」を選択した場合は即座に中断。

### ステップ6: ブランチ整理の実行

承認後、以下を実行:

1. **mainブランチに切り替え**
   ```bash
   git checkout main
   ```

2. **mainブランチを最新に更新**
   ```bash
   git pull origin main
   ```

   結果例:
   ```
   Fast-forward
    src/App.tsx | 10 +++++++---
    1 file changed, 7 insertions(+), 3 deletions(-)
   ```

3. **マージ済みブランチを削除**
   ```bash
   # 安全な削除（マージ済みのみ）
   git branch -d feature/issue-1
   git branch -d feature/issue-2
   git branch -d fix/typo
   ```

   各ブランチ削除時の出力:
   ```
   Deleted branch feature/issue-1 (was abc1234).
   Deleted branch feature/issue-2 (was def5678).
   Deleted branch fix/typo (was ghi9012).
   ```

4. **未マージブランチの処理**

   未マージブランチがある場合は警告表示:
   ```
   ⚠️ 未マージブランチ: feature/wip

   このブランチはmainにマージされていません。
   削除する場合は強制削除が必要です:
     git branch -D feature/wip

   保持しますか？ [Y/n]:
   ```

### ステップ7: 実行結果の報告

#### 単一プロジェクトモード

```
✅ ブランチクリーンアップ完了: growth-diary

📊 実行結果:
- 削除されたブランチ: 3件
  - feature/issue-1
  - feature/issue-2
  - fix/typo

- mainブランチ更新: 最新 (7コミット先行)

- 保護されたブランチ: 1件
  - feature/wip (未マージ)

現在のブランチ: main
```

#### 全プロジェクトモード

```
✅ 全プロジェクトのブランチクリーンアップ完了

📊 実行サマリー:
- 処理成功: 8プロジェクト
- スキップ: 2プロジェクト (未コミット変更あり)
- 削除されたブランチ: 27件

プロジェクト別詳細:

✅ growth-diary
  - 削除: 3ブランチ
  - mainブランチ: 最新

✅ portfolio
  - 削除: 5ブランチ
  - mainブランチ: 最新 (3コミット先行)

⚠️ source-flow
  - スキップ理由: 未コミット変更あり

✅ hobby-weather
  - 削除: 2ブランチ
  - mainブランチ: 最新

...

合計削除ブランチ数: 27
```

## 使用例

### 例1: 単一プロジェクトのクリーンアップ

**ユーザー**: growth-diary のブランチを整理して

**スキルの動作**:
1. growth-diaryディレクトリに移動
2. git statusで状態確認
3. 安全性チェック → OK
4. 3つのマージ済みブランチを特定
5. ユーザーに確認
6. 承認後、ブランチ削除 + main更新
7. 結果報告

### 例2: 全プロジェクト一括クリーンアップ

**ユーザー**: すべてのプロジェクトのブランチを整理して

**スキルの動作**:
1. [プロジェクトルート]配下の全プロジェクトを検出
2. 8プロジェクトを特定
3. 各プロジェクトで安全性チェック
4. 合計27ブランチが削除対象
5. ユーザーに確認
6. 承認後、各プロジェクトで処理実行
7. 全体サマリー報告

### 例3: カレントディレクトリで実行

**ユーザー**: ブランチをクリーンアップして

**スキルの動作**:
1. カレントディレクトリから自動判定
2. 以降は例1と同じフロー

### 例4: 安全でない状態

**ユーザー**: ブランチを整理して

**スキルの動作**:
1. 状態確認
2. 未コミット変更を検出
3. **スキップして警告表示**:
   ```
   ⚠️ ブランチクリーンアップをスキップしました

   理由: 未コミットの変更があります

   変更されたファイル:
     M  src/App.tsx
     ?? src/NewFile.tsx

   先にコミットまたはスタッシュしてください:
     git add .
     git commit -m "変更を保存"
     # または
     git stash
   ```

## エラーハンドリング

### プロジェクト関連

**プロジェクトディレクトリが存在しない**:
```
❌ エラー: プロジェクト '[プロジェクト名]' が見つかりません

確認してください:
  [プロジェクトルート]/[プロジェクト名]
```

**Gitリポジトリではない**:
```
❌ エラー: '[プロジェクト名]' はGitリポジトリではありません

Git初期化が必要な場合:
  cd "[プロジェクトルート]/[プロジェクト名]"
  git init
```

### Git操作関連

**リモートとの通信エラー**:
```
❌ エラー: リモートリポジトリに接続できません

原因: ネットワークエラーまたは認証失敗

対処方法:
1. ネットワーク接続を確認
2. 認証情報を確認: git config --list
3. リモートURLを確認: git remote -v
```

**ブランチ削除失敗**:
```
❌ エラー: ブランチ 'feature/issue-1' の削除に失敗しました

原因: ブランチがmainにマージされていません

対処方法:
1. マージ状況を確認:
     git log main..feature/issue-1

2. 強制削除する場合（注意）:
     git branch -D feature/issue-1
```

**mainブランチの更新失敗**:
```
❌ エラー: mainブランチの更新に失敗しました

原因: ローカルの変更とコンフリクト

対処方法:
  git stash
  git pull origin main
  git stash pop
```

## 設定オプション

プロジェクトルートに `.claude/branch-cleanup-config.json` を配置することで動作をカスタマイズ:

```json
{
  "protectedBranches": ["main", "develop", "staging"],
  "autoConfirm": false,
  "deleteUnmerged": false,
  "skipProjects": ["legacy-project", "archived-repo"],
  "logResults": true,
  "logPath": "./logs/branch_cleanup.log"
}
```

## 注意事項

1. **破壊的操作**
   - ローカルブランチが削除されます
   - 削除前に重要な作業がコミット・プッシュされているか確認

2. **安全機能**
   - 未コミット・未プッシュがある場合は自動スキップ
   - マージされていないブランチは保護
   - ユーザー確認を必ず実施

3. **リモート確認**
   - リモートにプッシュされていないコミットがあるブランチは保護
   - `git push`を先に実行してください

4. **全プロジェクトモード**
   - 処理時間がかかる場合があります
   - ネットワーク接続が必要
   - 個別エラーは記録して処理継続

5. **対象範囲**
   - `[プロジェクトルート]`直下の`.git`を持つディレクトリのみ
   - サブディレクトリのリポジトリは対象外

## 関連コマンド・スキル

- `/branch-cleanup [プロジェクト名|all]` - カスタムスラッシュコマンド版
- `issue-fixer` - Issue対応スキル（ブランチ作成）
- `pr-creator` - PR作成スキル（プッシュ実行）

## トラブルシューティング

### スキルが発動しない

- 「ブランチ整理」「クリーンアップ」などのキーワードを使用
- 例: 「growth-diaryのブランチを整理して」

### ブランチが削除されない

- 未マージの場合は保護されます
- マージ状況を確認: `git branch --merged main`
- 必要に応じて手動でマージまたは削除

### 全プロジェクトモードが遅い

- プロジェクト数が多い場合は時間がかかります
- 特定のプロジェクトのみ処理する場合は単一モードを使用
- スキップ対象を設定ファイルで指定可能
